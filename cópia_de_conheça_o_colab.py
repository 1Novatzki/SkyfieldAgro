# -*- coding: utf-8 -*-
"""CÃ³pia de ConheÃ§a o Colab

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KFrA_B-6hjMTTdfslgUiFWEZG1o8syoH
"""

import requests
from bs4 import BeautifulSoup
import matplotlib.pyplot as plt
from datetime import date, timedelta
import csv
import os

# Cidades e URLs
cidades = {
    "Guarapuava": "https://www.tempo.com/guarapuava.htm",
    "Curitiba": "https://www.tempo.com/curitiba.htm"
}

# Faixas ideais de temperatura para cada cultura
culturas = {
    "milho": (25, 30),
    "soja": (20, 30),
    "cevada": (4, 15),
    "feijao": (17, 28),
    "batata": (7, 20),
    "aveia": (7, 15),
    "trigo": (5, 20)
}

recomendacoes = {
    "milho": "Ideal para plantio com temperaturas entre 25Â°C e 30Â°C. Evite perÃ­odos frios.",
    "soja": "Desenvolvimento ideal entre 20Â°C e 30Â°C. Monitorar chuvas na floraÃ§Ã£o.",
    "cevada": "Cultivo favorÃ¡vel entre 4Â°C e 15Â°C. Prefere clima frio e seco.",
    "feijao": "SensÃ­vel a geadas. Cresce melhor entre 17Â°C e 28Â°C.",
    "batata": "Evite calor excessivo. Temperatura ideal entre 7Â°C e 20Â°C.",
    "aveia": "Prefere clima frio e Ãºmido entre 7Â°C e 15Â°C.",
    "trigo": "Desenvolve-se bem entre 5Â°C e 20Â°C. Chuvas no inÃ­cio podem favorecer.",
}

weekday_map = {0: "Seg", 1: "Ter", 2: "Qua", 3: "Qui", 4: "Sex", 5: "SÃ¡b", 6: "Dom"}
hoje = date.today()
dias_labels = [weekday_map[(hoje + timedelta(days=i)).weekday()] for i in range(7)]

# Coleta de temperaturas
def coletar_temperaturas(url):
    headers = {"User-Agent": "Mozilla/5.0"}
    soup = BeautifulSoup(requests.get(url, headers=headers).text, "html.parser")
    try:
        temp_atual = soup.find("span", class_="dato-temperatura changeUnitT").text.strip()
        previsoes = soup.find_all("span", class_="temp")
        max_vals = [int(temp_atual.replace("Â°", ""))]
        min_vals = [int(temp_atual.replace("Â°", ""))]

        for i in range(1, 7):
            max_i = previsoes[i].find("span", class_="max changeUnitT").text.strip()
            min_i = previsoes[i].find("span", class_="min changeUnitT").text.strip()
            max_vals.append(int(max_i.replace("Â°", "")))
            min_vals.append(int(min_i.replace("Â°", "")))
        return max_vals, min_vals
    except Exception as e:
        print(f"Erro: {e}")
        return None, None

# AnÃ¡lise e geraÃ§Ã£o de CSV
def analisar_e_exportar(cidade, max_vals, min_vals):
    print(f"\nğŸ“„ Gerando relatÃ³rio para {cidade}...")

    nome_arquivo = f"{cidade.lower()}_relatorio.csv"
    with open(nome_arquivo, mode="w", newline="", encoding="utf-8") as file:
        writer = csv.writer(file)
        writer.writerow(["Dia", "Cultura", "Temperatura MÃ¡xima", "Temperatura MÃ­nima", "Status", "RecomendaÃ§Ã£o TÃ©cnica"])

        for cultura, (minimo, maximo) in culturas.items():
            print(f"\nğŸŒ± {cultura.capitalize()} ({minimo}Â°â€“{maximo}Â°C)")
            propicios = 0
            for i in range(7):
                mn = min_vals[i]
                mx = max_vals[i]
                status = "PropÃ­cio" if (mn >= minimo and mx <= maximo) else "NÃ£o propÃ­cio"
                if status == "PropÃ­cio":
                    propicios += 1
                writer.writerow([
                    dias_labels[i],
                    cultura.capitalize(),
                    f"{mx}Â°C",
                    f"{mn}Â°C",
                    status,
                    recomendacoes[cultura]
                ])
                print(f"  {dias_labels[i]}: MÃ¡x {mx}Â° / MÃ­n {mn}Â° â†’ {status}")
            if propicios == 7:
                print("  âœ… Totalmente propÃ­cio.")
            elif propicios >= 4:
                print(f"  âš ï¸ Parcialmente propÃ­cio ({propicios}/7 dias).")
            else:
                print(f"  âŒ Pouco propÃ­cio ({propicios}/7 dias).")

    print(f"ğŸ“ CSV salvo como: {os.path.abspath(nome_arquivo)}")

# GeraÃ§Ã£o de grÃ¡fico
def gerar_grafico(cidade, max_vals, min_vals):
    plt.figure()
    plt.plot(dias_labels, max_vals, marker='o', label="MÃ¡xima")
    plt.plot(dias_labels, min_vals, marker='o', label="MÃ­nima")
    plt.title(f"PrevisÃ£o de Temperatura - {cidade}")
    plt.xlabel("Dia da Semana")
    plt.ylabel("Temperatura (Â°C)")
    plt.legend()
    plt.grid(True)
    plt.tight_layout()
    plt.xticks(rotation=45)
    plt.show()

# ExecuÃ§Ã£o
for cidade, url in cidades.items():
    print(f"\nğŸ” Coletando dados de {cidade}...")
    max_vals, min_vals = coletar_temperaturas(url)
    if max_vals and min_vals:
        gerar_grafico(cidade, max_vals, min_vals)
        analisar_e_exportar(cidade, max_vals, min_vals)